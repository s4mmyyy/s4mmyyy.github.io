<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0 user-scalable=1" name="viewport">
    <title>s4mmy&#39;s blog</title> <!--ä½¿ç”¨configä¸­çš„å…¨å±€å˜é‡titleä½œä¸ºæ ‡é¢˜-->
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="s4mmy's blog" type="application/atom+xml">
</head>
    
    <body>
        <header class="header">
    <div class="title">
        <a href="/" class="logo" >s4mmy&#39;s blog</a>
    </div>
    <nav class="navbar">
        <ul class="menu">
            
                <a href="/" class="menu-item-link">Home</a>   
            
                <a href="/journals/" class="menu-item-link">Journals</a>   
            
                <a href="/technical/" class="menu-item-link">Technical</a>   
            
                <a href="/other/" class="menu-item-link">Other</a>   
            
                <a href="/about/" class="menu-item-link">About</a>   
            
        </ul>
    
    </nav>
    
    
</header>



        
        <div class="container">
            <div style="border-bottom:1px solid #eaedf3;"></div>
            
            <article class="post-content">
    <div class="post-title">
        <h2>ä¸€é“nodejsæ±¡æŸ“+jwtçˆ†ç ´çš„é¢˜</h2>
    </div>
    <div>
        <span class="post-time">2023-07-01</span>
    </div>
    <div class="post-font">
        <h2 id="Nodejså‘½ä»¤æ‰§è¡Œ"><a href="#Nodejså‘½ä»¤æ‰§è¡Œ" class="headerlink" title="Nodejså‘½ä»¤æ‰§è¡Œ"></a>Nodejså‘½ä»¤æ‰§è¡Œ</h2><p>åˆæ˜¯å¤ç°å…¶ä»–å¸ˆå‚…åšå®¢ä¸Šçš„é¢˜ç›®çš„ä¸€å¤©~</p>
<p>è¿™é¢˜çš„æ•´ä½“ç»“æ„è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯åšçš„è¿‡ç¨‹è¿˜æ˜¯è¸©äº†ä¸å°‘çš„å‘ã€‚</p>
<p><img src="/../../img/nodejs_image/1.png"></p>
<p>çœ‹èµ·æ¥éœ€è¦è·å¾—adminæƒé™</p>
<p>æŠ“ä¸ªåŒ…çœ‹ä¸€ä¸‹</p>
<p><img src="/../../img/nodejs_image/2.png"></p>
<p>coockieéƒ¨åˆ†çœ‹èµ·æ¥æœ‰ç‚¹åƒJWTï¼Œç†ç”±æ˜¯ç”±ä¸‰éƒ¨åˆ†åŠ å¯†ç»„æˆï¼Œä¸”ç”±ç‚¹è¿›è¡Œè¿æ¥ã€‚</p>
<p>åˆ°jwt.ioè¿›è¡Œè§£å¯†</p>
<p><img src="/../../img/nodejs_image/3.png"></p>
<p>å°è¯•å°†guestæ”¹æˆadminå†ä¼ å…¥ï¼Œç„¶è€Œè¿˜æ˜¯ä¸è¡Œã€‚</p>
<p>å¯ä»¥æ¨æµ‹è¿™é‡Œæ˜¯ä½¿ç”¨äº†å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œè¿™é‡Œå¯¹jwtå¼±å¯†é’¥è¿›è¡Œçˆ†ç ´ï¼Œç¼–å†™å¦‚ä¸‹è„šæœ¬</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">#jwtjåŠ å¯†keyå€¼çˆ†ç ´è„šæœ¬
import jwt
#åœ¨è¿™é‡Œè¾“å…¥jwt token
jwt_str&#x3D;&#39;&#39;

f&#x3D;open(&#39;keys.txt&#39;)#åœ¨è¿™é‡ŒæŒ‡å®šå­—å…¸æ–‡ä»¶
for i in f:
    try:
        jwt.decode(jwt_str, verify&#x3D;True, key&#x3D;i, algorithms&#x3D;&#39;HS256&#39;)
        print(&#39;the key is &#39;+i)
        break
    except (jwt.exceptions.ExpiredSignatureError,jwt.exceptions.InvalidAudienceError,jwt.exceptions.InvalidIssuedAtError,jwt.exceptions.InvalidIssuedAtError,jwt.exceptions.ImmatureSignatureError):
        print(&#39;there are something wrong,but the key is&#39; + i)#æ•°æ®éƒ¨åˆ†é¢„å®šä¹‰å­—æ®µé”™è¯¯,ä½†æ˜¯keyæ˜¯æ­£ç¡®çš„
        break
    except jwt.exceptions.InvalidSignatureError:
        continue
else:
    print(&#39;found no key&#39;)</code></pre>

<p><img src="/../../img/nodejs_image/4.png"></p>
<p>é‡æ–°è¿›è¡Œç¼–ç æˆåŠŸè¿›å…¥<code>/source</code>é¡µé¢ï¼Œé‡Œé¢æ˜¯å¦‚ä¸‹æºç </p>
<pre class="line-numbers language-Javascript" data-language="Javascript"><code class="language-Javascript">const express &#x3D; require(&quot;express&quot;);
const jwt &#x3D; require(&quot;jsonwebtoken&quot;);
const app &#x3D; express();
const bodyParser &#x3D; require(&quot;body-parser&quot;);
const path &#x3D; require(&quot;path&quot;);
const jwt_secret &#x3D; &quot;toor&quot;;
const cookieParser &#x3D; require(&quot;cookie-parser&quot;);
const putil_merge &#x3D; require(&quot;putil-merge&quot;);
app.use(cookieParser());
app.use(bodyParser.urlencoded(&#123; extended: true &#125;)).use(bodyParser.json());

var Super &#x3D; &#123;&#125;;

var safecode &#x3D; function (code) &#123;
  let validInput &#x3D;
    &#x2F;global|mainModule|constructor|read|write|_load|exec|spawnSync|stdout|eval|stdout|Function|setInterval|setTimeout|var|\+|\*&#x2F;gi;
  return !validInput.test(code);
&#125;;

app.all(&quot;&#x2F;code&quot;, (req, res) &#x3D;&gt; &#123;
  res.type(&quot;html&quot;);
  if (req.method &#x3D;&#x3D; &quot;POST&quot; &amp;&amp; req.body) &#123;
    putil_merge(&#123;&#125;, req.body, &#123; deep: true &#125;);
  &#125;
  res.send(&quot;welcome to code&quot;);
&#125;);

app.get(&quot;&#x2F;source&quot;, (req, res) &#x3D;&gt; &#123;
  res.type(&quot;html&quot;);
  var auth &#x3D; req.cookies.auth;
  jwt.verify(auth, jwt_secret, function (err, decoded) &#123;
    if (decoded.user &#x3D;&#x3D;&#x3D; &quot;admin&quot;) &#123;
      res.sendFile(path.join(__dirname + &quot;&#x2F;app.js&quot;));
    &#125; else &#123;
      res.end(&quot;you are not admin&quot;);
    &#125;
  &#125;);
&#125;);

app.all(&quot;&#x2F;root&quot;, (req, res) &#x3D;&gt; &#123;
  res.type(&quot;html&quot;);
  code &#x3D; req.body.code;
  console.log(req.body.key);
  if (!req.body.key || req.body.key &#x3D;&#x3D;&#x3D; undefined || req.body.key &#x3D;&#x3D;&#x3D; null) &#123;
    res.send(&quot;please input key&quot;);
  &#125; else &#123;
    if (Super[&quot;userid&quot;] &#x3D;&#x3D;&#x3D; &quot;Superadmin&quot; + req.body.key) &#123;
      if (!safecode(code)) &#123;
        res.send(&quot;forbidden!&quot;);
      &#125; else &#123;
        res.send(eval(code));
      &#125;
    &#125; else &#123;
      res.send(&quot;You are not the Super&quot;);
    &#125;
  &#125;
&#125;);

app.get(&quot;&#x2F;&quot;, (req, res) &#x3D;&gt; &#123;
  res.type(&quot;html&quot;);
  var token &#x3D; jwt.sign(&#123; user: &quot;guest&quot; &#125;, jwt_secret, &#123; algorithm: &quot;HS256&quot; &#125;);
  res.cookie(&quot;auth &quot;, token);
  res.end(&quot;Only admin can get source in &#x2F;source&quot;);
&#125;);

app.listen(3000, () &#x3D;&gt; console.log(&quot;Server started on port 3000&quot;));
</code></pre>



<p>åœ¨<code>/root</code>è·¯ç”±ä¸‹æœ‰ä¸€ä¸ªevalå‡½æ•°å¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œç„¶è€Œè¦è¿›å…¥evalå‡½æ•°çš„åˆ¤æ–­å‰ææ˜¯<code>Super[&quot;userid&quot;] === &quot;Superadmin&quot;+req.body.key</code>å’Œ<code>key</code>å€¼ä¸ä¸ºç©º</p>
<p>åœ¨å¾€ä¸Šåœ¨<code>code</code>è·¯ç”±ä¸‹æœ‰ä¸€ä¸ª<code>putil_merge</code>å‡½æ•°è¿›è¡Œmergeæ“ä½œï¼Œå¯ä»¥æ¨æ–­è¿™é‡Œè¦ä½¿ç”¨åŸå‹é“¾æ±¡æŸ“ã€‚</p>
<p>è¿™é‡Œç°åœ¨<code>code</code>å¤„æ±¡æŸ“<code>userid</code>çš„å€¼ï¼Œç„¶åå†åœ¨rootä¸‹ä¼ å…¥<code>key</code>å’Œ<code>code</code>çš„å€¼ä¾¿å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œäº†ã€‚</p>
<p>åŸå…ˆæˆ‘ä¸çŸ¥é“<code>req.body.key</code> è¿™ä¸ªå‚æ•°å¯ä»¥ç”¨POSTæˆ–è€…jsonç›´æ¥ä¼ å‚èµ‹å€¼ï¼Œè¿˜åœ¨æƒ³è¦å¦‚ä½•æ±¡æŸ“æ‰èƒ½ç»•è¿‡åˆ¤æ–­ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå¡äº†ä¸€ä¼šã€‚ã€‚ã€‚</p>
<p>å…¶å®åœ¨ç¨‹åºæœ€ä¸Šé¢é‚£ä¸€éƒ¨åˆ†å°±è¯´æ˜äº†å¯ä»¥ä½¿ç”¨jsonæˆ–è€…POSTä¼ å‚</p>
<pre class="line-numbers language-Javascript" data-language="Javascript"><code class="language-Javascript">app.use(bodyParser.urlencoded(&#123; extended: true &#125;)).use(bodyParser.json());</code></pre>

<p>å¡ä½æˆ‘çš„ç¬¬äºŒä¸ªç‚¹æ˜¯æˆ‘ä¸çŸ¥é“<code>Super[&quot;userid&quot;]</code>å…¶å®å°±ç›¸å½“äº<code>Super.userid</code>æ‰€ä»¥åªè¦æ±¡æŸ“åŸå‹é“¾ä¸Šçš„<code>userid</code>å°±å¤Ÿäº†ï¼Œåœ¨å¤´å‡ è¡Œä¹Ÿå®šä¹‰äº†è¯´<code>Super</code>æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ã€‚è¿™æå¾—æˆ‘ä¹Ÿæƒ³äº†ä¸€æ®µæ—¶é—´è¦æ€ä¹ˆå»æ±¡æŸ“<code>Super[&quot;userid&quot;]</code>è¿™ä¸ªå‚æ•°ã€‚ã€‚ã€‚</p>
<p>è¿˜æœ‰å°±æ˜¯<code>Super[&quot;userid&quot;] === &quot;Superadmin&quot; + req.body.key</code>ä¸­çš„<code>&quot;Superadmin&quot; + req.body.key</code>å…¶å®å°±æ˜¯ç®€å•çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå½“æ—¶ä¹Ÿä¸çŸ¥é“è‡ªå·±æ˜¯è„‘è¢‹æŠ½äº†è¿˜æ˜¯æ€ä¹ˆäº†ï¼Œæƒ³ä¸è¿‡æ¥è¿™ä¸ªè¦æ€ä¹ˆå¤„ç†ã€‚ã€‚ã€‚</p>
<p>è¯¥æ¸…æ¥šä¸Šé¢é‚£äº›åŸç†åï¼Œæ¥ç€å¯ä»¥æ„é€ å‘åŒ…äº†ã€‚</p>
<p>é¦–å…ˆæ˜¯codeè·¯ç”±ä¸‹çš„æ„é€ </p>
<p><img src="/../../img/nodejs_image/5.png"></p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥<code>Content-type:application/json</code>,æˆ‘ä¸€å¼€å§‹æ²¡æœ‰æ³¨æ„ï¼ŒæŠŠå®ƒåŠ åˆ°<code>Accept</code>å¤´é‡Œå»äº†ï¼Œæ•´äº†åŠå¤©æ‰å‘ä¸‹åŠ é”™åœ°æ–¹äº†ã€‚ã€‚ã€‚ã€‚</p>
<p>æ¥ç€æ˜¯rootè·¯ç”±ä¸‹çš„æ„é€ </p>
<p><img src="/../../img/nodejs_image/6.png"></p>
<p><code>key</code>å€¼ä¼ å…¥<code>zzz</code>ä¸<code>Superadmin</code>æ‹¼æ¥é€šè¿‡åˆ¤æ–­ï¼ŒåŒæ—¶<code>code</code>è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p>
<p>è¿™é‡Œä½¿ç”¨çš„æ˜¯POSTç›´æ¥ä¼ å‚ï¼Œæ‰€ä»¥è¦å†™æˆ<code>Content-type:application/x-www-form-urlencoded</code></p>
<p>åœ¨æºç å¤„æˆ‘ä»¬æœ‰æ³¨æ„åˆ°<code>code</code>å…¶å®æ˜¯è¿›è¡Œäº†æ­£åˆ™åŒ¹é…è¿‡æ»¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å¸¸è§bypassè¿›è¡Œç»•è¿‡</p>
<pre class="line-numbers language-none"><code class="language-none">16è¿›åˆ¶ç¼–ç 
unicodeç¼–ç 
åŠ å·æ‹¼æ¥
æ¨¡æ¿å­—ç¬¦ä¸²
concatå‡½æ•°è¿æ¥
base64ç¼–ç </code></pre>

<p>åœ¨è¿™é‡Œæˆ‘æ˜¯ç”¨çš„æ˜¯16è¿›åˆ¶ç¼–ç ã€‚å¦å¤–æˆ‘å‘ç°åªæœ‰è¿›è¡ŒåŒæ­¥è¿›ç¨‹åˆ›å»ºæ‰å¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>æœ€ååœ¨è®°å½•ä¸€ä¸ªå¤§å‘ï¼Œä»Šå¤©è¿™ä¸ªæ´å…¶å®æ˜¯ä¸ªCVEï¼Œå½±å“ç‰ˆæœ¬ä»1.0.0 åˆ° 3.6.6ã€‚è€Œæˆ‘ä¸€å¼€å§‹å®‰è£…çš„putil-mergeæ˜¯3.10.10çš„ç‰ˆæœ¬ï¼Œå·²ç»ä¿®å¤äº†è¯¥ååºåˆ—åŒ–æ¼æ´ï¼Œå¡äº†æˆ‘ä¸€ä¸‹åˆã€‚ã€‚ã€‚ã€‚åé¢æ‰å‘ç°æ˜¯å› ä¸ºç‰ˆæœ¬åŸå› ï¼Œä¸‹æ¬¡ä¹Ÿè¦å¤šæ³¨æ„ä¸€ç‚¹äº†ã€‚ã€‚</p>
<h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/237032#h2-0">nodejsä¸­ä»£ç æ‰§è¡Œç»•è¿‡çš„ä¸€äº›æŠ€å·§-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>
<p><a target="_blank" rel="noopener" href="http://47.103.121.189/2022/08/19/node-js%E4%B8%80%E9%81%93%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E8%B8%A9%E5%9D%91%E8%AE%B0/">å“ˆå“ˆï¼Œéª—ä½ çš„ï¼ãƒ¾(ï¾Ÿâˆ€ï¾Ÿã‚)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/acbb936e87df">https://www.jianshu.com/p/acbb936e87df</a></p>

    </div>
</article>
<!--æ˜¾ç¤ºæ–‡ç« é¡µç›¸å…³å†…å®¹-->
            <!--bodyæ˜¯ä¸€ä¸ªå˜é‡ï¼Œä»£è¡¨é¡µé¢çš„ä¸»è¦å†…å®¹ã€‚åœ¨æ¸²æŸ“æ¨¡æ¿æ—¶ï¼Œè¿™ä¸ªå˜é‡ä¼šè¢«æ›¿æ¢ä¸ºå®é™…çš„å†…å®¹ã€‚-->
            

            <div style="border-bottom:1px solid #eaedf3;"></div>

            <footer class="footer">
    <p>s4mmy &copy; 2025&nbsp;| &nbsp;Recorded for better expressionğŸ§¡&nbsp;|
        <a href="https://github.com/s4mmyyy/hexo-theme-life" target="_blank" class="theme">&nbsp;Theme</a>
    
    </p>
</footer>
        </div>
        
    </body>
</html>